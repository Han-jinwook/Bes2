# Bes2 핵심 분석 로직 및 기능 정의서 (v1.5 - The Simplified Pipeline)

**Date:** 2025-12-01
**Status:** Pipeline Normalized & Stability Secured
**Updated by:** User & AI Assistant

---

## 1. Bes2의 핵심 4대 기능 (The Big 4)

리포트(현황판)와 꿀팁(정보)을 제외한, 사용자가 실제로 사진을 정리하는 **핵심 액션 기능 4가지**입니다.

### ① 추억 소환 (Memory Recall)
*   **유형:** UI 카드
*   **목적:** **"과거의 특별한 날 재발견"**.
*   **대상:** 1년 전 오늘 등 사진이 많이 찍힌 특정 이벤트 날짜.
*   **동작:** 해당 날짜의 사진만 격리하여 보여주고 정리 유도.
*   **DB:** 본채(`review_items`) / `source_type = 'MEMORY'`.

### ② 갤러리 다이어트 (Gallery Diet)
*   **유형:** UI 카드
*   **목적:** **"과거 사진 스캔 및 정리"** (조금씩 꾸준히).
*   **대상:** 앱 실행 시점 기준 과거의 모든 사진들.
*   **동작:** 
    *   **입구 개방:** 갤러리에서 필터 없이 최신순으로 사진을 가져옵니다.
    *   **분류 (Worker):** 
        *   스크린샷/문서/사물 -> **쓰레기통 DB**로 자동 분류.
        *   일반 사진 -> **다이어트 DB**로 분류하여 정밀 분석 대기.
    *   **UI:** 발견된 일반 사진(DIET)의 개수를 표시합니다.
*   **DB:** 본채(`review_items`) / `source_type = 'DIET'`.

### ③ 스크린샷 정리 (Trash Cleaning)
*   **유형:** UI 카드
*   **목적:** **"쓰레기통 비우기"**.
*   **대상:** 스크린샷, 문서, **사물(Object)** 등 '버릴 사진'.
*   **동작:** 
    *   **즉시 감지 (Instant Load):** 앱 실행 즉시 갤러리에서 스크린샷 개수를 파악하여 UI에 표시 (반응 속도 최적화).
    *   **백그라운드 수집:** `PhotoDiscoveryWorker`가 다이어트 스캔 중 발견한 쓰레기 사진들을 DB에 추가.
*   **DB:** 별채(`trash_items`) / `status = 'READY'`.

### ④ 분류된 사진 정리하기 (Instant Review)
*   **유형:** 하단 메인 버튼 (파란 테두리)
*   **목적:** **"방금 찍은 사진 즉시 정리"** (앱 사용 중 촬영분).
*   **대상:** **앱 시작(감지 서비스 실행) 시점 이후**에 촬영된 모든 사진.
*   **기준점:** `MediaDetectionService` 시작 시 저장된 `APP_START_TIME`.
*   **동작:** 
    *   실시간 촬영 감지 -> **1분 후** 분석 시작 -> 알림/버튼 활성화.
*   **DB:** 본채(`review_items`) / `source_type = 'INSTANT'`.

---

## 2. 시스템 아키텍처 및 통일성 (Uniformity)

### ⚙️ 1. 분석 파이프라인: 단일 엔진, 이원화 저장 (One Engine, Dual Storage)
*   **입구 (Fetcher):** `GalleryRepository`는 복잡한 조건 없이 **'모든 사진'**을 가져옵니다 (Android 15 호환성 확보).
*   **분배기 (Dispatcher):** `PhotoDiscoveryWorker`가 가져온 사진을 검사하여 **분배**합니다.
    *   **Trash Route:** 경로명(`Screenshot`, `Capture`) 또는 AI 판단(`Document`, `Object`) -> `TrashItemEntity`
    *   **Diet Route:** 그 외 정상 사진 -> `ReviewItemEntity`
*   **결과:** SQL 레벨의 복잡한 필터링 오류를 제거하고, 코드 레벨에서 정교하게 분류합니다.

---

## 3. 데이터베이스 및 처리 흐름 (The Pipeline)

### 🧱 데이터의 이원화 (DB 분리)
*   **본채 (`ReviewItemEntity`):** 소중한 사진용 (추억, 다이어트, 분류된 정리).
*   **별채 (`TrashItemEntity`):** 쓰레기 사진용 (스크린샷 정리).

---

## 4. UI 동작 원리 (UX Logic)

*   **다이어트 버튼:** Worker가 DB에 채워넣은 `DIET` 사진 개수 표시.
*   **쓰레기통 버튼:** **(즉시)** 갤러리 스크린샷 개수 표시 + **(보완)** Worker가 찾아낸 쓰레기 사진들.
*   **분류된 정리 버튼:** `INSTANT` 소스의 분석 완료된 사진이 있을 때만 활성화.
