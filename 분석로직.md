# Bes2 핵심 분석 로직 및 기능 정의서 (v1.7 - Safety First)

**Date:** 2025-12-01
**Status:** All Core Logic Verified & Stabilized
**Updated by:** User & AI Assistant

---

## 1. Bes2의 핵심 4대 기능 (The Big 4)

리포트(현황판)와 꿀팁(정보)을 제외한, 사용자가 실제로 사진을 정리하는 **핵심 액션 기능 4가지**입니다.

### ① 추억 소환 (Memory Recall)
*   **유형:** UI 카드
*   **목적:** **"과거의 특별한 날 재발견"**.
*   **대상:** 1년 전 오늘 등 사진이 많이 찍힌 특정 이벤트 날짜.
*   **동작:** 해당 날짜의 사진만 격리하여 보여주고 정리 유도.
*   **DB:** 본채(`review_items`) / `source_type = 'MEMORY'`.

### ② 갤러리 다이어트 (Gallery Diet)
*   **유형:** UI 카드
*   **목적:** **"과거 사진 스캔 및 정리"** (조금씩 꾸준히).
*   **대상:** 앱 실행 시점 기준 과거의 모든 사진들.
*   **동작:** 
    *   **입구 개방:** 갤러리에서 필터 없이 최신순으로 사진을 가져옵니다.
    *   **분류 (Worker):** 
        *   스크린샷/문서/사물 -> **쓰레기통 DB**로 자동 분류.
        *   일반 사진 -> **다이어트 DB**로 분류하여 정밀 분석 대기.
    *   **UI:** 발견된 일반 사진(DIET)의 개수를 표시합니다.
*   **DB:** 본채(`review_items`) / `source_type = 'DIET'`.

### ③ 스크린샷 정리 (Trash Cleaning)
*   **유형:** UI 카드
*   **목적:** **"쓰레기통 비우기"**.
*   **대상:** 스크린샷, 문서, **사물(Object)** 등 '버릴 사진'.
*   **우선순위 로직 (Priority):**
    1.  **1순위:** `MediaStore`의 **진짜 스크린샷** (ScreenShots 폴더).
    2.  **2순위:** Worker가 찾아낸 **DB 쓰레기 아이템** (문서, 사물 등).
    *   **동작:** 한 번에 30장씩 로딩하며, 삭제/보관 완료 시 즉시 다음 배치를 리필(Refill)함.
*   **DB:** 별채(`trash_items`) / `status = 'READY'`.

### ④ 분류된 사진 정리하기 (Instant Review)
*   **유형:** 하단 메인 버튼 (파란 테두리)
*   **목적:** **"방금 찍은 사진 즉시 정리"** (앱 사용 중 촬영분).
*   **대상:** **앱 시작(감지 서비스 실행) 시점 이후**에 촬영된 모든 사진.
*   **기준점:** `MediaDetectionService` 시작 시 저장된 `APP_START_TIME`.
*   **동작:** 
    *   실시간 촬영 감지 -> **10초 후** 분석 시작 -> 알림/버튼 활성화.
*   **DB:** 본채(`review_items`) / `source_type = 'INSTANT'`.

---

## 2. 정밀 분석 및 필터링 로직 (The Core Logic)

**[원칙] 심플하고 강력하게 (Simple & Strong)**
복잡한 가중치나 보정 로직을 배제하고, 확실한 결함이 발견되면 즉시 탈락시킵니다.

### A. 안전 장치: 오분류 방지 (Safety Net)
`ImageContentClassifier`에서 분류 시 **사람(Face)** 을 최우선으로 보호합니다.

*   **얼굴 감지 우선 (Face First):** 라벨 분석 전, 반드시 얼굴 인식을 먼저 수행.
*   **절대 보호:** 얼굴이 **1개라도 감지되면(아무리 작아도)** 무조건 **일반 사진(MEMORY)** 으로 분류.
    *   **설정:** `PERFORMANCE_MODE_ACCURATE` (정확도 우선), 최소 크기 제한 없음.
    *   **효과:** 인물 사진이 쓰레기통으로 오분류되는 사고 원천 차단.

### B. 1차 관문: 결함 감지 (Fail Fast)
`PhotoAnalysisWorker`에서 수행하며, 하나라도 걸리면 즉시 **`STATUS_REJECTED`** 처리하고 점수 계산을 생략합니다.

1.  **눈 감음 감지 (EyeClosedDetector)**
    *   **설정:** 랜드마크 OFF, 최소 얼굴 크기 설정 없음 (순정 상태 유지).
    *   **임계값 (Threshold):** **0.3**
        *   `LeftOpenProbability` < **0.3** 또는 `RightOpenProbability` < **0.3** 이면 감음 판정.
    *   **판정:** 한쪽 눈이라도 감기면 `True` (감음).
    *   **결과:** 감음 감지 시 `STATUS_REJECTED`.

2.  **흐림 감지 (Blur)**
    *   **도구:** OpenCV Laplacian Variance (자체 구현).
    *   **임계값:** **30.0** 미만.
    *   **결과:** 30.0 미만 시 `STATUS_REJECTED`.

3.  **역광 감지 (Backlight)**
    *   **로직:** 얼굴 영역의 평균 밝기가 배경보다 현저히 낮을 때.
    *   **결과:** 역광 감지 시 `STATUS_REJECTED`.

### C. 2차 관문: 점수 계산 (Scoring)
1차 관문을 통과한(`ANALYZED`) 사진에 한해서만 수행합니다.

*   **점수 항목:** NIMA(심미성), Musiq(화질), Smile(미소).
*   **실패작 처리:** `STATUS_REJECTED`된 사진은 점수 계산을 **건너뜀(SKIP)** -> 점수 `null` 또는 `0` 처리.
    *   **효과:** 점수가 없으므로 베스트 사진 경쟁에서 **원천 배제됨**.

---

## 3. 클러스터링 및 알림 로직

### A. 클러스터링 (ClusteringWorker)
*   **대상:** `ANALYZED` (성공) 및 `STATUS_REJECTED` (실패) 상태이지만 아직 클러스터 ID가 없는(`cluster_id IS NULL`) 모든 항목.
*   **동작:**
    1.  **성공작(`ANALYZED`):** 시간(3분) 및 유사도(Phash/Face) 기준으로 그룹핑. -> `PENDING_REVIEW` 클러스터 생성.
    2.  **실패작(`STATUS_REJECTED`):** 
        *   성공작 클러스터가 있으면 거기에 병합 (딸려감).
        *   성공작이 없으면(전부 실패 시) **"쓰레기 클러스터"** 를 생성하여 묶음.
    *   **중요:** 실패작도 반드시 `cluster_id`를 부여하여 DB에 업데이트해야 함 (무한 루프 방지).
        *   이때 상태는 `STATUS_REJECTED`를 **유지**해야 함 (`updateClusterIdOnly`).

### B. 알림 (Notification)
*   **트리거:** `ClusteringWorker` 완료 시점.
*   **조건:** 처리된 사진(`candidates`)이 **1장이라도 있으면** 무조건 발송.
    *   성공작이 0개여도(전부 실패여도) 알림 발송.
*   **내용:** "N장의 사진 분석이 완료되었습니다." (성공/실패 여부 무관).
*   **동작:** 알림 클릭 시 `MainActivity`로 이동 -> 리뷰 화면 진입.

---

## 4. 데이터베이스 및 처리 흐름 (The Pipeline)

### 🧱 데이터의 이원화 (DB 분리)
*   **본채 (`ReviewItemEntity`):** 소중한 사진용 (추억, 다이어트, 분류된 정리).
*   **별채 (`TrashItemEntity`):** 쓰레기 사진용 (스크린샷 정리).

### 🔄 상태 전이 (State Transition)
1.  **NEW** (초기)
2.  **ANALYZED** (성공) or **STATUS_REJECTED** (실패: 눈감음/흔들림)
3.  **CLUSTERED** (그룹핑 완료: ReviewViewModel 로딩 가능)
4.  **KEPT** (보관됨) or **DELETED** (삭제됨)
