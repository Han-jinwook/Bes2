# Bes2 핵심 분석 로직 및 기능 정의서 (v2.1 - Enhanced UX)

**Date:** 2025-12-03
**Status:** Architecture Refined & Stabilized
**Updated by:** User & AI Assistant

---

## 1. 데이터 수집 파이프라인 (The Pipeline)

**[핵심 철학] Simple & Robust (단순하고 강력하게)**
복잡한 페이징이나 날짜 계산을 배제하고, 안드로이드 표준 `Cursor`를 이용해 **한 번에 전체를 훑는 스트림(Stream) 방식**을 사용합니다.

### A. 전수 스캔 및 분류 (PhotoDiscoveryWorker)
*   **방식:** `ContentResolver`로 `Cursor`를 열고 갤러리 전체를 스캔합니다.
*   **분류(Classification):** 경로명(`screenshot`, `capture`) 및 1차 AI 분류로 '쓰레기(Trash)'와 '분석 대상(Diet)'을 즉시 분류합니다.
*   **UX 연동:** 이 단계가 끝나면 **'쓰레기 정리' 기능이 즉시 활성화**됩니다. (AI 분석을 기다리지 않음).
*   **진행률:** 전체 스캔 개수(`totalScanCount`)를 `SettingsRepository`에 저장합니다.

### B. 전수 분석 (PhotoAnalysisWorker)
*   **트리거:** 스캔(`Discovery`)이 끝나면 자동으로 실행됩니다.
*   **방식:** '분석 대상(Diet)'으로 분류된 사진들을 하나씩 정밀 분석(눈 감음, 흔들림, 구도 등)합니다.
*   **UX 연동:**
    *   **실시간 카운팅:** 1장을 분석할 때마다 진행률을 저장하여 UI에 **"(350 / 1063)"** 형태로 실시간 표시합니다.
    *   **대기 안내:** 분석이 완료될 때까지 '다이어트' 카드는 "AI 심층 분석 중..." 상태를 유지합니다.
*   **안전 장치:**
    *   **군복/야간 구제:** AI 분류가 불확실하면 무조건 `MEMORY`(본채)로 보냅니다.
    *   **얼굴 구제:** 얼굴 크기가 3% 미만이면 눈 감음 검사를 생략합니다.

### C. 클러스터링 및 알림 (ClusteringWorker)
*   **마무리:** 분석된 사진들을 그룹핑(`CLUSTERED`)하여 UI에서 바로 보여줄 수 있게 준비합니다.
*   **완료:** 작업이 완료되면 '다이어트' 카드가 활성화됩니다.
*   **알림:** 작업 완료 시 사용자에게 알림을 보냅니다.

---

## 2. Bes2의 핵심 4대 기능 (The Big 4)

### ① 추억 소환 (Memory Recall)
*   **대상:** 여행, 이벤트 등 사진이 많이 촬영된 특정 날짜의 사진.
*   **동작:** 하루에 **20장 이상** 촬영된 날짜를 감지하여, 해당 날짜의 사진만 격리하여 정리 유도.
*   **알림:** "추억 소환 🎉: {날짜}의 추억 ({개수}장), 지금 정리해볼까요?"

### ② 갤러리 다이어트 (Gallery Diet)
*   **목적:** **"쌓여있는 과거 사진 정복"**.
*   **동작:**
    *   **준비 중:** "AI 심층 분석 중... (현재/전체)" 실시간 진행률 표시.
    *   **완료 후:** "N장 중 M장 정리 추천" 메시지와 함께 활성화.
    *   **무한 리필:** DB 선행 확보를 통해 끊김 없는 경험 제공.
*   **DB:** `review_items` (Source: `DIET`).

### ③ 스크린샷/불필요 사진 비우기 (Trash Cleaning)
*   **목적:** **"빠른 쓰레기통 비우기"**.
*   **대상:** `Discovery` 단계에서 식별된 스크린샷, 문서, 사물 사진.
*   **동작:**
    *   **스캔 중:** "전체 갤러리 분류 중... (잠시만요)"
    *   **스캔 완료:** 즉시 활성화되어 "정리할 사진 N장 발견 (지금 바로 비우기)" 표시.
*   **DB:** `trash_items` (Status: `READY`).

### ④ 분류된 사진 정리하기 (Instant Review)
*   **목적:** **"방금 찍은 사진 즉시 정리"**.
*   **동작:** 앱 사용 중 촬영된 사진을 감지하여 즉시 분석 및 알림.

---

## 3. 리포트 및 광고 정책 (Report & Ads)

### A. 활동량 리포트 (Daily Activity)
*   **기준:** **"오늘 내가 정리(터치)한 횟수"**.
*   **구현:** `SettingsRepository`의 카운터를 통해 삭제/보관 시 즉시 +1.
*   **초기화:** 날짜가 바뀌면 0으로 자동 초기화.

### B. 전면 광고 (Interstitial Ad)
*   **조건:** 사진 정리 누적 **30장** 마다 노출.
*   **독립 카운팅:** 다이어트 화면과 쓰레기통 화면의 카운트를 별도로 관리합니다.

---

## 4. 권한 및 설정
*   **권한:** `CAMERA` 권한 제거, `READ_MEDIA_IMAGES` 필수.
*   **설정:** 클라우드 동기화 옵션 제공 (기본값: OFF 또는 Wifi Only).
