# Bes2 핵심 분석 로직 및 기능 정의서 (v2.0 - Full Stream Architecture)

**Date:** 2025-12-03
**Status:** Architecture Refined & Stabilized
**Updated by:** User & AI Assistant

---

## 1. 데이터 수집 파이프라인 (The Pipeline)

**[핵심 철학] Simple & Robust (단순하고 강력하게)**
복잡한 페이징이나 날짜 계산을 배제하고, 안드로이드 표준 `Cursor`를 이용해 **한 번에 전체를 훑는 스트림(Stream) 방식**을 사용합니다.

### A. 전수 스캔 (PhotoDiscoveryWorker)
*   **방식:** `ContentResolver`로 `Cursor`를 열고, 최신 사진부터 과거 순으로 하나씩 읽어들입니다 (`moveToNext`).
*   **효율성:** 이미 DB에 처리된(`isUriProcessed`) 사진은 0.001초 만에 건너뜁니다.
*   **배치 처리:** 메모리 보호를 위해 100장 단위로 모아서 DB에 `INSERT` 합니다.
*   **제한 없음:** `LIMIT` 없이 갤러리 끝까지 탐색하여 누락을 방지합니다.
*   **Foreground Service:** 긴 작업이므로 알림을 띄우고 시스템에 의해 죽지 않도록 보호합니다.

### B. 전수 분석 (PhotoAnalysisWorker)
*   **트리거:** 스캔(`Discovery`)이 끝나면 자동으로 실행됩니다.
*   **방식:** DB에서 `status='NEW'`인 사진을 **모두 찾아서** 분석할 때까지 반복(`do-while`)합니다.
*   **안전 장치:**
    *   **군복/야간 구제:** AI 분류가 불확실하면 무조건 `MEMORY`(본채)로 보냅니다. (쓰레기통 오분류 절대 방지).
    *   **얼굴 구제:** 얼굴 크기가 3% 미만이면 눈 감음 검사를 생략합니다.
    *   **기준 완화:** 흐림 점수 `20.0` 미만만 실패 처리.

### C. 클러스터링 및 알림 (ClusteringWorker)
*   **마무리:** 분석된 사진들을 그룹핑(`CLUSTERED`)하여 UI에서 바로 보여줄 수 있게 준비합니다.
*   **알림:** 작업이 완료되면 **"사진 정리 준비 완료!"** 알림을 보냅니다. (최초 1회 즉시, 이후 하루 1회 제한).

---

## 2. Bes2의 핵심 4대 기능 (The Big 4)

### ① 추억 소환 (Memory Recall)
*   **대상:** 여행, 이벤트 등 사진이 많이 촬영된 특정 날짜의 사진.
*   **동작:** 하루에 **20장 이상** 촬영된 날짜를 감지하여, 해당 날짜의 사진만 격리하여 정리 유도.

### ② 갤러리 다이어트 (Gallery Diet)
*   **목적:** **"쌓여있는 과거 사진 정복"**.
*   **동작:**
    *   **준비된 데이터:** Worker가 미리 분석해둔 수천 장의 사진이 DB에 대기 중입니다.
    *   **UI:** 사용자가 들어오면 로딩 없이 즉시 30장씩 꺼내줍니다.
    *   **무한 리필:** DB에 데이터가 충분하므로 별도의 리필 로직 없이 계속 다음 장을 보여줍니다.
*   **DB:** `review_items` (Source: `DIET`).

### ③ 스크린샷/불필요 사진 비우기 (Trash Cleaning)
*   **목적:** **"쓰레기통 비우기"**.
*   **대상:**
    *   **1순위:** `MediaStore`의 진짜 스크린샷 폴더.
    *   **2순위:** Worker가 갤러리 전역에서 찾아낸 문서/사물 사진(`TrashItem`).
*   **동작:** 삭제 시 즉시 목록을 갱신하고 다음 쓰레기를 보여줍니다.
*   **DB:** `trash_items` (Status: `READY`).

### ④ 분류된 사진 정리하기 (Instant Review)
*   **목적:** **"방금 찍은 사진 즉시 정리"**.
*   **동작:** 앱 사용 중 촬영된 사진을 감지하여 즉시 분석 및 알림.

---

## 3. 리포트 및 광고 정책 (Report & Ads)

### A. 활동량 리포트 (Daily Activity)
*   **기준:** **"오늘 내가 정리(터치)한 횟수"**.
*   **구현:** `SettingsRepository`의 카운터를 통해 삭제/보관 시 즉시 +1. (과거 사진 정리도 포함).
*   **초기화:** 날짜가 바뀌면 0으로 자동 초기화.

### B. 전면 광고 (Interstitial Ad)
*   **조건:** 사진 정리 누적 **30장** 마다 노출.
*   **독립 카운팅:** 다이어트 화면과 쓰레기통 화면의 카운트를 별도로 관리합니다.

---

## 4. 권한 및 설정
*   **권한:** `CAMERA` 권한 제거 (촬영 기능 없음), `READ_MEDIA_IMAGES`(또는 `READ_EXTERNAL_STORAGE`) 필수.
*   **설정:** 클라우드 동기화 옵션 제공 (기본값: OFF 또는 Wifi Only).
