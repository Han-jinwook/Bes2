# Bes2 핵심 분석 로직 및 기능 정의서 (v2.2 - Sequential Pipeline)

**Date:** 2025-12-04
**Status:** Pipeline Optimized & Stabilized
**Updated by:** User & AI Assistant

---

## 1. 데이터 수집 파이프라인 (The 5-Step Pipeline)

**[핵심 철학] Sequential & Stable (순차적이고 안정적이게)**
기존의 병렬 처리 방식을 버리고, 한 단계가 완전히 끝나야 다음 단계가 시작되는 **엄격한 순차 실행 모델**을 적용하여 시스템 안정성과 발열 문제를 해결합니다.

### Step 1. 분류 및 스캔 (PhotoDiscoveryWorker)
*   **동작:** 갤러리 전체를 스캔하며 1차 분류 수행 (Trash vs Diet).
*   **정책:** `KEEP` (이미 돌고 있으면 건드리지 않음).
*   **결과:** DB에 `NEW` 또는 `READY` 상태로 데이터 저장.

### Step 2. 쓰레기 알림 (Notify Trash)
*   **시점:** `PhotoDiscoveryWorker` 작업 완료 즉시.
*   **동작:** "새로운 사진 묶음이 준비되었습니다" 알림 발송. '쓰레기 정리' 버튼 활성화.

### Step 3. 정밀 분석 (PhotoAnalysisWorker)
*   **트리거:** Step 1 완료 후 자동 실행 (`triggerAnalysis`).
*   **동작:** '다이어트' 대상 사진 정밀 분석 (눈 감음, 흔들림, 구도 등).
*   **안전 장치 (Safety Net):**
    *   **군복/야간 구제:** AI 분류가 불확실하더라도 '군복'이나 '야간' 키워드가 있으면 무조건 `ANALYZED`(합격) 처리.
    *   **얼굴 구제:** 얼굴 크기가 3% 미만이면 눈 감음 검사 생략.
*   **UX:** 1장마다 진행률 업데이트 -> UI에 실시간 카운팅 표시.

### Step 4. 클러스터링 및 다이어트 알림 (ClusteringWorker)
*   **트리거:** Step 3 완료 후 자동 실행.
*   **동작:** 유사 사진 그룹핑 및 베스트 컷 선정.
*   **결과:** "N장 중 M장 정리 추천" 알림 발송. '다이어트' 버튼 활성화.

### Step 5. 추억 소환 (Memory Recall)
*   **트리거:** **모든 분석 작업(Step 1~4)이 완전히 종료된 시점**을 `HomeViewModel`이 감지.
*   **동작:** `loadMemoryEvent()` 호출. 하루 20장 이상 촬영된 날짜를 찾아 제안.
*   **이점:** 분석이 다 끝난 깨끗한 데이터를 사용하므로 "분석 중..." 대기 시간이 없음.

---

## 2. Bes2의 핵심 4대 기능 (The Big 4)

### ① 추억 소환 (Memory Recall)
*   **대상:** 하루 20장 이상 촬영된 이벤트성 날짜.
*   **특징:** 가장 마지막에 활성화됨 (분석 완료 후).

### ② 갤러리 다이어트 (Gallery Diet)
*   **목적:** "쌓여있는 과거 사진 정복".
*   **동작:** 실시간 분석 카운팅 제공.

### ③ 스크린샷/불필요 사진 비우기 (Trash Cleaning)
*   **목적:** "빠른 쓰레기통 비우기".
*   **개선사항:** **30장 제한 해제.** DB에 있는 모든 쓰레기와 실시간 스크린샷을 합쳐서 한 번에 보여줌.

### ④ 분류된 사진 정리하기 (Instant Review)
*   **목적:** "방금 찍은 사진 즉시 정리".

---

## 3. 리포트 및 광고 정책 (Report & Ads)
*   **활동량 리포트:** 삭제/보관 시 즉시 카운팅.
*   **전면 광고:** 사진 정리 누적 30장마다 노출.

---

## 4. 권한 및 설정
*   **권한:** `READ_MEDIA_IMAGES` 필수.
*   **설정:** 클라우드 동기화 옵션 제공.
