# Bes2 핵심 분석 로직 (v7.4 - Finalized)

**Date:** 2025-12-06
**Status:** 파이프라인 완전 자동화 및 로직 확정
**Author:** User & AI Assistant

---

## Ⅰ. 데이터 처리 파이프라인: 5단계 순차 실행 모델

**[핵심 원칙] 순차적 안정성 (Sequential Stability)**
모든 데이터 처리(스캔, 분석, 클러스터링, 추억)는 **엄격한 순서**에 따라 실행됩니다. 이전 단계가 성공적으로 완료(`SUCCEEDED`)되어야만 다음 단계가 활성화됩니다.

### **[STEP 1] 1차 분류 (Discovery)**
*   **Worker:** `PhotoDiscoveryWorker`
*   **실행 시점:** 앱 최초 실행 시 즉시 & 24시간 주기.
*   **역할:** 갤러리 스캔 및 1차 분류 (Trash vs Diet).
*   **AI Policy (중요 변경):**
    *   확실한 문서/사물 -> **Trash**
    *   확실한 인물/음식 -> **Diet** (Keep)
    *   **애매한 사진 (Uncertain) -> Trash (Object)** 
        *   *이유:* 사물 인식률을 높이기 위해, AI가 확신하지 못하는 사진은 '정리 대상'으로 간주합니다.

### **[STEP 2] 쓰레기 정리 알림 (Trash Notification)**
*   **시점:** 1단계 완료 직후.
*   **동작:** "불필요한 사진 정리" 알림 발송.
*   **특징:** **30장 제한 없음.** 발견된 모든 쓰레기 사진을 한 번에 보여줍니다.

### **[STEP 3] 정밀 분석 (Analysis)**
*   **Worker:** `PhotoAnalysisWorker`
*   **트리거:** 1단계 완료 시 자동 실행 (체이닝).
*   **역할:** 'Diet' 대상 사진 정밀 분석 (흔들림, 눈 감음 등).
*   **특징:** `try-catch` 강화로 개별 파일 에러가 전체 스캔을 멈추지 않음.

### **[STEP 4] 클러스터링 및 다이어트 알림 (Clustering)**
*   **Worker:** `ClusteringWorker`
*   **트리거:** 3단계 완료 시 자동 실행.
*   **역할:** 유사 사진 그룹핑 & 베스트 컷 선정.
*   **Finish Condition:** 이 작업이 `SUCCEEDED` 상태가 되어야만 5단계 진입 가능.

### **[STEP 5] 추억 소환 (Memory Recall)**
*   **Worker:** `MemoryEventWorker`
*   **트리거:** **`HomeViewModel`이 4단계(Clustering)의 성공을 확인한 후** 실행.
    *   *조건:* `!analysisInProgress` AND `isClusteringFinished`
*   **역할:** 하루 20장 이상 촬영된 날짜를 분석하여 '추억 소환' 제안.
*   **UI 동작:** 분석이 완료되기 전에는 버튼이 비활성화되며, 완료 즉시 알림과 함께 활성화됨.

---

## Ⅱ. 주요 변경 이력 (Troubleshooting)

### 1. 사물 사진 미분류 문제
*   **원인:** AI 분류기의 안전장치가 "애매하면 보존(`MEMORY`)"하도록 설정되어 있어, 책상/의자 등이 추억으로 분류됨.
*   **해결:** `ImageContentClassifier`의 Default 정책을 **`OBJECT` (쓰레기)**로 변경.

### 2. 추억 소환 오작동 (앱 시작 시)
*   **원인:** 앱 초기화 시점에 작업 상태(`WorkInfo`)가 로드되기 전, "작업 없음"을 "작업 완료"로 착각하여 즉시 실행됨.
*   **해결:** `HomeViewModel`에서 **"과거에 4단계 작업이 성공한 기록이 있는지"** 확인하는 로직 추가.

### 3. 쓰레기 목록 30장 제한
*   **원인:** `TrashItemDao`의 쿼리에 `LIMIT` 절이 포함되어 있었음.
*   **해결:** `LIMIT` 제거 및 `getAllReadyTrashItems()` 메소드 신설.

---

## Ⅲ. 알림 정책

| 구분 | Notification ID | 정책 | 비고 |
| :--- | :--- | :--- | :--- |
| **쓰레기 정리** | 1001 | 즉시 알림 | 1단계 완료 시 |
| **다이어트** | 1002 | 즉시 알림 | 4단계 완료 시 |
| **추억 소환** | 1003 | 즉시 알림 | 5단계 완료 시 |
| **인스턴트** | 1004 | 즉시 알림 | 촬영 직후 |
