Best2 앱 개발 계획 (PLAN.md) - v3.9 (2025-11-21)

1. 앱의 핵심 목표

한 줄 요약: "찍고 잊어도, 하루 사진은 스스로 정리되어 2장만 남는다. 나는 마지막에 30초만 확인하면 끝."

가치 제안: "나는 여전히 마음껏 찍는다. 대신 앱이 먼저 정리하고 나는 마지막에 두 번만 누른다."

제공 가치: 시간 절약, 마음의 여유, 저장 공간 확보, 결정 피로 감소, 안전한 보관(휴_지통 및 클라우드 백업)

1.5. 앱의 핵심 원칙 (Bes2의 약속)

조용한 작동 (Silent Butler): 사용자의 사진 촬영 경험을 방해하지 않고, 백그라운드에서 눈에 띄지 않게 작동한다.

지능적인 기다림 (Intelligent Patience): 사진 촬영이 일단락되었다고 판단될 때까지 지능적으로 기다린 후 분석을 시작한다.

최소한의 개입 유도 (Minimal Interruption): 사용자의 확인이 필요한 경우에만 가장 적절한 방식으로 검토를 요청한다.

결정 피로 최소화 (Effortless Decision): 복잡한 선택 과정 없이, 최소한의 터치로 사진 정리를 완료할 수 있도록 돕는다.

자동화 우선 (Automation First): 사용자가 신경 쓰지 않아도 대부분의 작업이 자동으로 이루어지도록 설계한다.

계획 우선, 실행은 승인 후 (Plan First, Act on Approval): (신규 규칙) 모든 코드 수정 전, 이 문서의 규칙에 따라 변경 사항을 보고하고, 반드시 사용자에게 허락을 받은 후에만 작업을 진행한다.

2. 주요 기능 및 현재 상태

자동 사진 정리: (완료)

사진 변경 감지 및 신규 사진 DB 저장.

클러스터링: (완료)

(상세 규칙은 3. 핵심 규칙 섹션으로 이동)

사진 분석 및 평가: (완료)

기본 품질 필터 (눈 감음, 흐림 정도).

미적 품질 평가 (NIMA 모델 활용).

웃음 확률 분석 (ML Kit Vision API 활용).

간편 검토 인터페이스: (부분 구현)

분석 완료 후, 검토가 필요한 클러스터가 있으면 사용자에게 알림을 보낸다.

검토 화면 구성:

베스트 1, 2: 점수 기준으로 선정된 베스트 사진 2장을 표시한다.

나머지: 베스트 사진으로 선정되지 않은 정상 사진 목록을 표시한다.

실패: (중요) 분석에 실패한 사진 목록을 표시하며, 각 사진마다 실패 사유(예: 눈감음, 흐림)를 명확히 Text로 표기한다.

클라우드 동기화: (부분 구현)

Google Photos 로그인/로그아웃 및 자동 백업.

수동 동기화 실행 기능.

3. 핵심 규칙 및 정책 (The Guardrails)

사진 처리 파이프라인 (Data Flow Pipeline) - v2.5 수정

1단계: 클러스터링 (ClusteringWorker):

새로운 사진(NEW 상태)이 감지되면, ClusteringWorker가 가장 먼저 실행된다.

(v3.7 추가) 스크린샷 제외 규칙: 파일 경로에 'Screenshot', 'Capture' 등이 포함된 이미지는 클러스터링 대상에서 제외하고 즉시 IGNORED 상태로 처리한다.

ClusteringWorker는 pHash를 직접 계산하여 비슷한 사진들을 하나의 '클러스터(묶음)'로 묶고, 각 사진에 클러스터 ID를 부여한다.

클러스터링이 완료된 사진들의 상태를 다음 단계를 위해 PENDING_ANALYSIS로 변경하고, PhotoAnalysisWorker를 호출한다.

2단계: 분석 및 상태 부여 (PhotoAnalysisWorker):

PhotoAnalysisWorker는 PENDING_ANALYSIS 상태의 사진들을 가져와 클러스터 단위로 분석을 시작한다.

품질 게이트: 3. 핵심 규칙의 '품질 게이트 규칙'에 따라 '눈 감음'과 '흐림'을 검사하여, 기준 미달인 사진은 즉시 STATUS_REJECTED(실패) 상태로 변경하고 더 이상의 점수 계산을 진행하지 않는다.

점수 계산: 품질 게이트를 통과한 사진에 대해서만 NIMA 점수와 웃음 확률을 계산하고, 상태를 ANALYZED(성공)로 변경한다.

모든 분석이 완료되면 사용자에게 검토 알림을 보낸다.

3단계: 점수화 및 UI 분리 표시 (ReviewViewModel & Screen):

(기존과 동일) 검토 화면에서는 ANALYZED 상태의 사진들만을 대상으로 최종 점수를 계산하여 '베스트'와 '나머지'를 선정한다.

(기존과 동일) STATUS_REJECTED 사진은 '실패' 섹션으로 분리하여 사용자에게 보여준다.

(기존 '구현 노트'는 v2.5의 본문과 내용이 일치하므로 삭제)

분석 시작 지연 규칙 (지능적인 기다림) - v3.6 신규

원칙: 1.5. 앱의 핵심 원칙의 '지능적인 기다림'을 구현하며, 사용자의 사진 촬영이 일단락될 때까지 대기합니다.

출처: (AS에이전트가 작업할 파일, 예: PhotoObserverService.kt or WorkScheduler.kt)

트리거: 마지막 사진 촬영(감지) 후, 사용자가 '설정'에서 지정한 시간 동안 추가 촬영이 없으면 ClusteringWorker(파이프라인 1단계)를 트리거합니다.

현재 테스트 값: 현재 테스트를 위해 기본값 1분으로 설정되어 있습니다.

다음 작업: AS에이전트가 '설정' UI에 해당 지연 시간(예: 1분, 30분, 1시간)을 사용자가 선택할 수 있는 옵션 추가 예정.

품질 게이트 규칙 (실패 사진 기준) - v3.4 신규

출처: PhotoAnalysisWorker.kt (및 EyeClosedDetector.kt)

눈 감음 (Eyes Closed) 기준:

ML Kit이 분석한 "눈을 떴을 확률 (open probability)" 값을 기준으로 합니다.

임계값 (v3.4 기록): 양쪽 눈 중 어느 한쪽이라도 "눈을 떴을 확률"이 0.5 미만일 경우, '눈 감은 사진'으로 판단하여 STATUS_REJECTED(실패) 처리합니다. (EyeClosedDetector.kt의 areEyesClosed 함수 로직)

흐림 (Blur) 기준:

(현재 임계값 미정의, AS에이전트의 확인 후 plan.md에 추가 필요)

자동 동기화 규칙 (안정적인 주기적 실행 보장) - v2.7 신규

원칙: 안드로이드의 배터리 최적화 정책으로 인해 신뢰도가 낮은 주기적 작업(PeriodicWorkRequest)을 사용하는 대신, 신뢰도 높은 일회성 작업(OneTimeWorkRequest)을 체인 형태로 연결하여 안정성을 보장합니다.

실행 순서:

SettingsViewModel: 사용자가 설정한 시간에 맞춰, 정확한 지연 시간(initialDelay)을 가진 OneTimeWorkRequest를 단 한 번만 예약합니다.

DailyCloudSyncWorker: 동기화 작업을 성공적으로 마친 후, 스스로 다음 날 같은 시간에 실행될 새로운 OneTimeWorkRequest를 다시 예약하고 작업을 종료합니다.

결과: 이 '릴레이' 방식을 통해, 시스템에 의해 작업이 무기한 연기되는 문제를 방지하고 매일 설정된 시간에 안정적으로 동기화를 실행할 수 있습니다.

클러스터링 규칙 (사진 묶음 기준) - v2.6 신규

출처: ClusteringWorker.kt

유사도 판단 기준: 두 사진의 pHash 값 사이의 해밍 거리(Hamming Distance)를 측정합니다.

임계값: 해밍 거리가 15 이하인 경우, 두 사진을 '유사한 사진'으로 판단하여 같은 클러스터로 묶습니다. (v2.6 수정: 임계값을 10에서 15로 완화하여, 조명이나 구도가 약간 다른 유사 사진도 하나의 클러스터로 묶일 확률을 높임)

점수 계산 규칙 (베스트 사진 선정 기준) - v3.7 수정

출처: ReviewViewModel.kt의 calculateFinalScore 함수.

점수 체계:

기본 점수 (최대 100점): NIMA 모델이 산출한 1~10점 사이의 미적 품질 원점수를, 사용자 편의를 위해 **100점 만점으로 환산(* 10)**하여 기본 점수로 사용합니다.

가산점 및 감점 (v3.7 수정):

가산점: ML Kit이 분석한 웃음 확률 점수에 30을 곱하여 가산점으로 사용합니다. (기존 10에서 상향 - 웃는 얼굴 우대)

감점: 웃음 확률이 0.1 미만인 경우(찡그림, 무표정 등), -10점을 감점합니다. (인상 쓴 사진 필터링)

최종 점수 산출 공식:

최종 점수 = (NIMA 원점수 * 10) + (웃음 확률 * 30 또는 -10)

이로 인해, 이론상 최고 점수는 **130점(100점 + 30점)**이 될 수 있습니다.

예시:

잘 웃는 사진 (NIMA 6.0, 웃음 0.9): 60 + 27 = 87점

찡그린 사진 (NIMA 6.4, 웃음 0.0): 64 - 10 = 54점 (NIMA가 높아도 웃는 사진에 패배하도록 설계)

4. 아키텍처 및 데이터 구조

아키텍처: Clean Architecture 변형 (app, data, domain, background, ml 등 모듈 분리).

의존성 주입 / UI / 비동기: Hilt / Jetpack Compose / Coroutines & Flow.

데이터베이스 구조 (Room Entities)

ImageItemEntity: 이미지 개별 정보 (id, uri, pHash, nIMA_Score, areEyesClosed, smilingProbability, clusterId, status 등)

ImageClusterEntity: 이미지 묶음 정보 (id, creationTime, reviewStatus)

5. 주요 개발 히스토리 (Milestones Achieved)

Milestone 1: 온디바이스 분석 파이프라인 구축

백그라운드 분석/클러스터링 자동화 파이프라인 완성.

Milestone 2: 사용자 검토 및 사진 관리 UI 구현

베스트 사진 2장 비교/선택 및 나머지 사진 관리 ReviewScreen UI 및 ViewModel 로직 완성.

Milestone 3: Google 포토 동기화 기능 완성

Google 로그인, 권한 획득, 자동 토큰 갱신 및 백그라운드 업로드 기능 완전 자동화 성공.

Milestone 4: MVP 안정화 및 설정 고도화 (v3.1 신규)

수동 동기화 UI/UX 개선 완료.

분석 완료 후 홈 리디렉션 로직 완료.

'Wi-Fi 연결 시에만 동기화' 옵션 기능 구현 완료. (WorkManager Constraints 적용 성공)

Milestone 5: 클라우드 스토리지 확장 (v3.7 수정)

'Naver MyBox' 연동 보류: 공개 API 부재로 인해 자동 업로드 구현이 불가능하여 기능 비활성화. Google Photos 단일 체제로 전환 및 최적화 완료.

Milestone 6: 통합 동기화 옵션 개선 (v3.5 신규)

통합 동기화 옵션 UI/UX 개선 (완료): 기존의 '매일 동기화'와 '분석 후 동기화'로 나뉘어 있던 옵션을 아래 4가지 선택지를 가진 하나의 설정으로 통합하여 사용자 편의성을 개선했습니다.

매일 설정시간 마다 동기화

분석 직후 바로바로 동기화

분석 직후 설정 시간 이후 동기화

자동 동기화 안함

각 시간 설정 옵션(매일/지연)을 선택하면, 해당 옵션 옆에 현재 설정된 시간이 버튼 형식으로 표시되어 즉시 수정할 수 있도록 UI를 개선했습니다.

자동 동기화 결과 알림 기능 (완료): 기존에 수동 동기화에만 제공되던 결과 피드백을 모든 자동 동기화(매일, 분석 직후 즉시/지연)로 확장했습니다. 이제 백그라운드에서 동기화가 완료되면, 성공적으로 백업된 사진 개수를 포함한 시스템 알림을 사용자에게 보내 명확한 피드백을 제공합니다.

Milestone 7: Refactoring & Optimization (v3.7 신규)

UI/UX 개선: 설정 화면(MyBox 제거, 팁 추가), 구글 포토 가이드 추가, 알림 고도화(N개 묶음/M장 백업 리포트), 피드백(완료 Toast) 개선.

안정성 강화: DB 트랜잭션 보장(NonCancellable), ClusteringWorker 자동 필터링(스크린샷 제외) 적용.

6. 다음 목표 (Next Mission) - POST MVP (v3.1)

(MVP 안정화 항목은 5. 주요 개발 히스토리 - Milestone 4로 이동됨)

1. 검토(Review) UX 고도화 (신규 기능)

ReviewScreen에서 클러스터 간 '앞/뒤 이동' 버튼 추가 (사전 검토 기능).

ReviewScreen의 '베스트 2장' 영역에서 최종 1장 남은 사진을, 인접 (앞/뒤) 클러스터로 보낼 수 있는 기능 추가 (클러스터링 오류 및 사용자 취향 보정).

'클러스터 미니맵' UI 추가 (신규): 검토 화면 상단에 전체 클러스터 대비 현재 위치를 시각적(예: ●●●○○)으로 표시하여 진행률 제공 (불확실성 해소).

2. 분석 로직 정교화 (AI/ML)

'실패 사진 살리기' (On-Demand 분석) (신규): ReviewScreen의 '실패' 섹션에서 사진 클릭 시, 즉시 NIMA/웃음 점수를 분석하고 ANALYZED 상태로 변경하여 '나머지' 섹션으로 이동시키는 기능. (ML 학습의 필수 선행 조건)

'품질 게이트' 항목 추가 (신규): '역광'(Backlighting) 등 새로운 객관적 실패 기준을 감지하여 STATUS_REJECETED로 분류하는 로직 추가 검토.

사용자 취향 학습 (ML) (신규): ('실패 사진 살리기'가 완료된 후) STATUS_REJECTED(실패) 사진을 사용자가 '베스트'로 살리는 패턴을 온디바이스로 학습하여, '실패' 판정 기준(예: 흐림, 눈감음)을 사용자 맞춤형으로 보정.

(기존 'NIMA 점수 보정...' 항목을 아래 내용으로 구체화)

카테고리별 점수 가중치 적용 (신규): NIMA를 보완하기 위해 '카테고리'(예: 음식, 인물, 풍경)를 ML Kit 이미지 라벨링으로 감지하고, 카테고리에 따라 점수 공식(가중치)을 다르게 적용.

(예: '음식' 사진은 '웃음 확률' 가중치 0, '색감/선명도' 가중치 상향)

추가 품질 지표 도입 (신규): '노출', '샤프니스', '색감(채도)' 등 NIMA가 보완하지 못하는 객관적 지표를 비트맵 분석 등으로 추가 검토. ('구도'는 난이도가 높아 장기 과제로 검토)

3. 동기화 및 설정 확장

(신규 '통합 동기화 옵션' 및 '자동 동기화 결과 알림' 항목은 Milestone 6로 이동하여 완료 처리)

(기존 'Naver MyBox' 항목은 Milestone 5로 이동하여 완료 처리)

4. 핵심 기능 확장

(기존 '이전 사진 정리 기능'을 아래 내용으로 구체화)

'이전 사진 정리' 기능 구현 (신규):

Trigger: 홈 화면에 '기존 갤러리 정리하기' 버튼 배치.

Options: '하루치', '일주일치', '한달치', '기간 선택' 등 (미분석된 사진 대상).

Action: 옵션 선택 시, 기존 분석 파이프라인(3. 핵심 규칙)을 재사용하여 해당 기간의 사진을 백그라운드로 분석/정리.

5. 수익화 모델

(기존 '수익화 모델'을 아래 내용으로 구체화)

AdMob 연동 및 정책 (신규):

띠 배너: '분석/검토 페이지'(ReviewScreen) 하단에 기본 띠 배너 광고 노출.

전면 광고: **'누적 분석 100장'**당 1회 전면 광고 노출.

Logic: 누적 분석 카운트(베스트/실패 무관)를 DB(or SharedPreferences)에 저장. 100장 도달 시 전면 광고를 노출하고 카운터 리셋.

6. 리포트 및 홈 UI (신규)

'하루 요약 리포트' (홈 UI): 홈 화면 하단에 오늘 총 촬영/분석/삭제/베스트 선정 매수를 요약 리포트로 상시 노출하여 앱의 가치를 사용자에게 증명.

'주간 요약 리포트' (On-Demand): '하루 요약 리포트' 영역 하단에 '주간 리포트 보기' 버튼을 배치하여, 사용자가 원할 때만 (Push 알림 없이) 지난주 성과를 볼 수 있도록 제공.

'PC 활용 가이드' (AI Toss) (v4.0 수정 - Waterfall):

목표: 홈 화면 하단에 "PC 큰 화면으로 정리하기" 버튼 배치.

동작(Action): 버튼 클릭 시, 다음 순서로 앱 감지 및 자동 실행 + 프롬프트 입력(Pre-fill).

1순위 (Gemini): Google Gemini 앱 (패키지 확인 후 실행).

2순위 (ChatGPT): ChatGPT 앱 (Gemini 없으면 실행).

3순위 (Web Browser): 앱 없으면 브라우저로 gemini.google.com 연결 (프롬프트는 클립보드에 복사).

7. 협업 원칙 (v3.7 - 신규 절차)

총감독: 최종 결정권자 (사용자).

재미나이: 캔버스 plan.md 관리자 (PM/Gemini, 본인).

AS에이전트: Android Studio AI 어시턴트 (윈드서퍼 에이전트).

7.1. AS에이전트 (Android Studio Agent)

총감독이 AS에이전트에게 지시할 때, AS에이전트가 준수해야 할 원칙

원칙 1 (기능 동결): 총감독의 명확한 허락 없이는 기존에 성공적으로 작동하는 기능 및 UI는 절대 수정하지 않는다.

원칙 2 (선 계획, 후 작업): 수정을 시작하기 전에, 변경 계획(Plan)을 먼저 총감독에게 제안하고 컨펌을 받는다. 컨펌이 완료된 후에만 실제 작업을 시작한다.

원칙 3 (결과 보고 / 파일 수정 금지):

AS에이전트는 plan.md를 포함한 어떤 기획 파일도 직접 수정할 수 없다.

작업 완료 후, plan.md 반영이 필요한 성과가 생기면, 변경이 필요한 [수정 전(Before)], [수정 후(After)] 또는 **[추가 사항]**을 명확히 워딩하여 총감독에게 텍스트로 보고한다.

원칙 4 (Git 커밋 보고):

(AS에이전트는) 코드 작업 완료 후, 총감독이 커밋/푸시를 요청할 때 깃허브에 반영할 터미널 명령어를 텍스트로 보고한다.

커밋 메시지는 "제목 1줄, 내용 2줄" 형식으로 작성한다.

제공 형식:

git add .
git commit -m "커밋 메시지 제목 (1줄 요약)

- 상세 내용 1
- 상세 내용 2
  "
  git push origin main


원칙 5 (로그 및 필터 요청) - v3.7 신규:

AS에이전트는 총감독에게 com.bes2.app 같은 긴 로그를 요청하지 않는다.

작업에 필요한 필터명이 있다면, 미리 총감독에게 마지막에 적어둔다.

7.2. 재미나이 (Gemini) 및 캔버스 관리

총감독이 이 캔버스에서 재미나이(PM/Gemini)와 'plan.md'를 관리할 때의 원칙

원칙 1 (Plan.md 수정 절차) - v3.7 신규 절차:

(재미나이는) [Before]/[After] 대신, 변경 사항에 대한 **'요약 보고'**를 채팅창에 제안한다.

총감독이 해당 '요약 보고'를 **컨펌(승인)**하면, (재미나이는) 캔버스의 plan.md 파일을 직접 수정한다.

(총감독은 캔버스에 시각적으로 표시되는 'diff/음영'를 통해 최종 변경을 확인할 수 있다.)

원칙 2 (수동 반영):

(재미나이는) plan.md 변경분에 대한 Git 명령어를 제공하지 않는다.

최종 plan.md 파일의 반영 및 모든 Git 명령어 실행 (코드 변경분, plan.md 변경분 모두)은캔버스 밖(Android Studio)에서 총감독이 AS에이전트의 보고를 받아 직접 수동으로 수행한다.