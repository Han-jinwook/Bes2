Best2 앱 개발 계획 (PLAN.md) - v2.6

1. 앱의 핵심 목표

한 줄 요약: "찍고 잊어도, 하루 사진은 스스로 정리되어 2장만 남는다. 나는 마지막에 30초만 확인하면 끝."

가치 제안: "나는 여전히 마음껏 찍는다. 대신 앱이 먼저 정리하고 나는 마지막에 두 번만 누른다."

제공 가치: 시간 절약, 마음의 여유, 저장 공간 확보, 결정 피로 감소, 안전한 보관(휴지통 및 클라우드 백업)

1.5. 앱의 핵심 원칙 (Bes2의 약속)

조용한 작동 (Silent Butler): 사용자의 사진 촬영 경험을 방해하지 않고, 백그라운드에서 눈에 띄지 않게 작동한다.

지능적인 기다림 (Intelligent Patience): 사진 촬영이 일단락되었다고 판단될 때까지 지능적으로 기다린 후 분석을 시작한다.

최소한의 개입 유도 (Minimal Interruption): 사용자의 확인이 필요한 경우에만 가장 적절한 방식으로 검토를 요청한다.

결정 피로 최소화 (Effortless Decision): 복잡한 선택 과정 없이, 최소한의 터치로 사진 정리를 완료할 수 있도록 돕는다.

자동화 우선 (Automation First): 사용자가 신경 쓰지 않아도 대부분의 작업이 자동으로 이루어지도록 설계한다.

계획 우선, 실행은 승인 후 (Plan First, Act on Approval): (신규 규칙) 모든 코드 수정 전, 이 문서의 규칙에 따라 변경 사항을 보고하고, 반드시 사용자에게 허락을 받은 후에만 작업을 진행한다.

2. 주요 기능 및 현재 상태

자동 사진 정리: (완료)

사진 변경 감지 및 신규 사진 DB 저장.

클러스터링: (완료)

(상세 규칙은 3. 핵심 규칙 섹션으로 이동)

사진 분석 및 평가: (완료)

기본 품질 필터 (눈 감음, 흐림 정도).

미적 품질 평가 (NIMA 모델 활용).

웃음 확률 분석 (ML Kit Vision API 활용).

간편 검토 인터페이스: (부분 구현)

분석 완료 후, 검토가 필요한 클러스터가 있으면 사용자에게 알림을 보낸다.

검토 화면 구성:

베스트 1, 2: 점수 기준으로 선정된 베스트 사진 2장을 표시한다.

나머지: 베스트 사진으로 선정되지 않은 정상 사진 목록을 표시한다.

실패: (중요) 분석에 실패한 사진 목록을 표시하며, 각 사진마다 실패 사유(예: 눈감음, 흐림)를 명확히 Text로 표기한다.

클라우드 동기화: (부분 구현)

Google Photos 로그인/로그아웃 및 자동 백업.

수동 동기화 실행 기능.

3. 핵심 규칙 및 정책 (The Guardrails)

사진 처리 파이프라인 (Data Flow Pipeline) - v2.5 수정

1단계: 클러스터링 (ClusteringWorker):

새로운 사진(NEW 상태)이 감지되면, ClusteringWorker가 가장 먼저 실행된다.

ClusteringWorker는 pHash를 직접 계산하여 비슷한 사진들을 하나의 '클러스터(묶음)'로 묶고, 각 사진에 클러스터 ID를 부여한다.

클러스터링이 완료된 사진들의 상태를 다음 단계를 위해 PENDING_ANALYSIS로 변경하고, PhotoAnalysisWorker를 호출한다.

2단계: 분석 및 상태 부여 (PhotoAnalysisWorker):

PhotoAnalysisWorker는 PENDING_ANALYSIS 상태의 사진들을 가져와 클러스터 단위로 분석을 시작한다.

품질 게이트: 먼저 '눈 감음'과 '흐림'을 검사하여, 기준 미달인 사진은 즉시 STATUS_REJECTED(실패) 상태로 변경하고 더 이상의 점수 계산을 진행하지 않는다.

점수 계산: 품질 게이트를 통과한 사진에 대해서만 NIMA 점수와 웃음 확률을 계산하고, 상태를 ANALYZED(성공)로 변경한다.

모든 분석이 완료되면 사용자에게 검토 알림을 보낸다.

3단계: 점수화 및 UI 분리 표시 (ReviewViewModel & ReviewScreen):

(기존과 동일) 검토 화면에서는 ANALYZED 상태의 사진들만을 대상으로 최종 점수를 계산하여 '베스트'와 '나머지'를 선정한다.

(기존과 동일) STATUS_REJECTED 사진은 '실패' 섹션으로 분리하여 사용자에게 보여준다.

(기존 '구현 노트'는 v2.5의 본문과 내용이 일치하므로 삭제)

클러스터링 규칙 (사진 묶음 기준) - v2.6 신규

출처: ClusteringWorker.kt

유사도 판단 기준: 두 사진의 pHash 값 사이의 해밍 거리(Hamming Distance)를 측정합니다.

임계값: 해밍 거리가 15 이하인 경우, 두 사진을 '유사한 사진'으로 판단하여 같은 클러스터로 묶습니다. (v2.6 수정: 임계값을 10에서 15로 완화하여, 조명이나 구도가 약간 다른 유사 사진도 하나의 클러스터로 묶일 확률을 높임)

점수 계산 규칙 (베스트 사진 선정 기준)

출처: ReviewViewModel.kt의 calculateFinalScore 함수.

점수 체계:

기본 점수 (최대 100점): NIMA 모델이 산출한 1~10점 사이의 미적 품질 원점수를, 사용자 편의를 위해 **100점 만점으로 환산(* 10)**하여 기본 점수로 사용합니다.

가산점 (최대 10점): ML Kit이 분석한 0.0~1.0 사이의 웃음 확률 점수에 10을 곱하여 가산점으로 사용합니다.

최종 점수 산출 공식:

최종 점수 = (NIMA 원점수 * 10) + (웃음 확률 * 10)

이로 인해, 이론상 최고 점수는 **110점(100점 + 10점)**이 될 수 있습니다.

예시: NIMA 원점수 5.9점, 웃음 확률 0.3인 사진의 최종 점수는 62점 (59 + 3)이 됩니다.

4. 아키텍처 및 데이터 구조

아키텍처: Clean Architecture 변형 (app, data, domain, background, ml 등 모듈 분리).

의존성 주입 / UI / 비동기: Hilt / Jetpack Compose / Coroutines & Flow.

데이터베이스 구조 (Room Entities)

ImageItemEntity: 이미지 개별 정보 (id, uri, pHash, nimaScore, areEyesClosed, smilingProbability, clusterId, status 등)

ImageClusterEntity: 이미지 묶음 정보 (id, creationTime, reviewStatus)

5. 주요 개발 히스토리 (Milestones Achieved)

Milestone 1: 온디바이스 분석 파이프라인 구축

백그라운드 분석/클러스터링 자동화 파이프라인 완성.

Milestone 2: 사용자 검토 및 사진 관리 UI 구현

베스트 사진 2장 비교/선택 및 나머지 사진 관리 ReviewScreen UI 및 ViewModel 로직 완성.

Milestone 3: Google 포토 동기화 기능 완성

Google 로그인, 권한 획득, 자동 토큰 갱신 및 백그라운드 업로드 기능 완전 자동화 성공.

6. 다음 목표 (Next Mission)

MVP 안정화

수동 동기화 UI/UX 개선 (완료)

SettingsViewModel과 SettingsScreen을 수정하여, 동기화 진행 상태 관리, 버튼 텍스트 변경 및 작업 완료 토스트 메시지로 명확한 피D백 제공 완료.

알림 클릭 동작 안정화

현상: 간헐적으로 사진 분석 완료 알림 클릭 시 ReviewActivity가 아닌 초기 홈 화면으로 이동.

해결: NotificationHelper의 Intent 생성 로직을 재검토하여 안정적인 화면 전환 보장.

Post-MVP

분석 로직 정교화: NIMA 점수 보정 로직 개발, 구도/색감 등 추가 분석 모델 도입 검토.

이전 사진 정리 기능: '설정'에 옵션을 추가하여, 앱 설치 이전의 사진들도 정리할 수 있는 기능 제공.

수익화 모델 도입: AdMob 라이브_러리를 연동하여 배너 또는 전면 광고 추가.

클라우드 스토리지 확장: Google Photos 외에 'Naver MyBox' 등 추가적인 클라우드 백업 옵션 제공.

7. 협업 원칙 (v2.4)

7.1. Android Studio 에이전트 (AS Agent)

총감독(사용자)이 AS 에이전트에게 지시할 때, 에이전트가 준수해야 할 원칙

원칙 1 (기능 동결): 기존에 성공적으로 작동하는 기능 및 UI는 총감독(사용자)의 명확한 허락 없이는 절대 수정하지 않는다.

원칙 2 (선 계획, 후 작업): 수정을 시작하기 전에, 변경 계획(Plan)을 먼저 사용자에게 제안하고 컨펌을 받는다. 컨펌이 완료된 후에만 실제 작업을 시작한다.

원칙 3 (결과 보고 / 파일 수정 금지):

에이전트는 plan.md를 포함한 어떤 기획 파일도 직접 수정할 수 없다.

작업 완료 후, plan.md 반영이 필요한 성과가 생기면, 변경이 필요한 [수정 전(Before)], [수정 후(After)] 또는 **[추가 사항]**을 명확히 워딩하여 총감독(사용자)에게 텍스트로 보고한다.

원칙 4 (Git 커밋 보고):

(AS 에이전트는) 코드 작업 완료 후, 총감독(사용자)이 커밋/푸시를 요청할 때 깃허브에 반영할 터미널 명령어를 텍스트로 보고한다.

커밋 메시지는 "제목 1줄, 내용 2줄" 형식으로 작성한다.

제공 형식:

git add .
git commit -m "커밋 메시지 제목 (1줄 요약)

- 상세 내용 1
- 상세 내용 2
  "
  git push origin main


7.2. 총감독 (Gemini) 및 캔버스 관리

사용자가 이 캔버스에서 총감독(Gemini)과 'plan.md'를 관리할 때의 원칙

원칙 1 (Plan.md 수정 절차):

(Gemini는) 사용자의 요청(AS 에이전트의 보고 기반)에 따라 plan.md의 **[수정 전(Before)]**과 **[수정 후(After)]**를 텍스트로 제안한다.

사용자가 해당 내용을 **컨펌(승인)**하면, (Gemini는) 이 캔버스에 있는 plan.md 파일을 그 내용대로만 업데이트한다.

원칙 2 (Git 커밋 연동):

plan.md가 캔버스에서 성공적으로 업데이트되면, (Gemini는) 터미널 3줄 요약(add, commit, push) 및 커밋 메시지(요약)를 함께 제공한다.

원칙 3 (수동 반영):

최종 plan.md 파일과 Git 명령어의 실제 반영은 캔버스 밖(Android Studio)에서 총감독(사용자)이 직접 수동으로 수행한다.